"use strict";(self.webpackChunkhajk_client=self.webpackChunkhajk_client||[]).push([[4906],{64906:function(e,t,i){i.r(t);var r=i(29439),a=i(1413),o=i(37762),n=i(15671),s=i(43144),c=i(63252),u=i(64665),l=i(66233),d=i(90927),h=i(5400),f=i(50315),v=i(56957),m=i(95881),y=i(34951),p=i(5426),g=i(28562),S=i(489),w=i(79717),k=i(56134),b=i(24673),Z=i(2177),F=i(50007),E=i.n(F),P=i(25806),L=function(){function e(t){var i=this;(0,n.Z)(this,e),this.loadDataSuccess=function(e){var t,r=new c.Z;try{t=r.readFeatures(e)}catch(a){alert("Fel: data kan inte l\xe4sas in. Kontrollera koordinatsystem.")}i.geometryName=t.length>0?t[0].getGeometryName():"geom",i.editSource.editableFields.some((function(e){return e.hidden}))&&(t=i.filterByDefaultValue(t)),i.vectorSource.addFeatures(t),i.vectorSource.getFeatures().forEach((function(e){e.on("propertychange",(function(t){"removed"!==e.modification&&"added"!==e.modification&&(e.modification="updated")})),e.on("change",(function(t){"removed"!==e.modification&&"added"!==e.modification&&(e.modification="updated")}))}))},this.removeSelected=function(e){i.map.forEachFeatureAtPixel(e.pixel,(function(e){i.vectorSource.getFeatures().some((function(t){return t===e}))&&("added"===e.modification?e.modification=void 0:e.modification="removed",e.setStyle(i.getHiddenStyle()))}))},this.resetEditFeature=function(){i.editFeatureBackup=i.editFeature,i.editFeature=void 0,i.observer.publish("editFeature",i.editFeature)},this.map=t.map,this.app=t.app,this.observer=t.observer,this.options=t.options,this.activeServices=this.options.activeServices,this.sources=this.options.sources,this.vectorSource=void 0,this.layer=void 0,this.select=void 0,this.modify=void 0,this.key=void 0,this.editFeature=void 0,this.editFeatureBackup=void 0,this.editSource=void 0,this.removeFeature=void 0,this.shell=void 0,this.instruction="",this.filty=!1,this.removalToolMode="off",this.options.sources=this.options.sources.map((function(e){0===e.uri.trim().length&&(e.uri="http://www.opengis.net/wfs");var t=new URL(e.url);return t.searchParams.delete("service"),e.url=t.href,e}))}return(0,s.Z)(e,[{key:"write",value:function(e){var t=new c.Z,i=this.editSource.layers[0].split(":"),r=2===i.length?i[0]:"",a=2===i.length?i[1]:i[0],o={featureNS:this.editSource.uri,featurePrefix:r,featureType:a,hasZ:!1,version:"1.1.0",srsName:this.editSource.projection};return t.writeTransaction(e.inserts,e.updates,e.deletes,o)}},{key:"refreshLayer",value:function(e){var t,i=this.map.getLayers().getArray().find((function(t){var i=!1;if(t.getSource().getParams){var r=t.getSource().getParams();if("object"===typeof r){var a=Array.isArray(r.LAYERS)?r.LAYERS[0].split(":"):r.LAYERS.split(":"),o=e.split(":");2===a.length&&2===o.length&&(i=e===r.LAYERS),1===a.length&&(i=o[1]===r.LAYERS)}}return i}));i&&((t=i.getSource()).changed(),t.updateParams({time:Date.now()}),this.map.updateSize())}},{key:"parseWFSTresponse",value:function(e){var t="string"!==typeof e?(new XMLSerializer).serializeToString(e):e;return(new(E())).xml2js(t)}},{key:"transact",value:function(e,t){var i=this,r=this.write(e),a=new XMLSerializer,o=this.editSource,n=r?a.serializeToString(r):void 0;n&&(0,P.hfetch)(o.url,{method:"POST",body:n,credentials:"same-origin",headers:{"Content-Type":"text/xml"}}).then((function(e){e.text().then((function(e){var r=i.parseWFSTresponse(e);r.ExceptionReport||!r.TransactionResponse||(i.refreshLayer(o.layers[0]),i.vectorSource.getFeatures().filter((function(e){return void 0!==e.modification})).forEach((function(e){return e.modification=void 0}))),t(r)}))})).catch((function(e){e.text().then((function(e){t(e)}))}))}},{key:"save",value:function(e){var t=this,i=function(e){return t.vectorSource.getFeatures().filter((function(t){return t.modification===e}))},r={updates:i("updated").map((function(e){return e.unset("boundedBy"),e})),inserts:i("added"),deletes:i("removed")};if(0===r.updates.length&&0===r.inserts.length&&0===r.deletes.length)return e();this.transact(r,e)}},{key:"getSelectStyle",value:function(e){return[new u.ZP({stroke:new l.Z({color:"rgba(0, 255, 255, 1)",width:3}),fill:new d.Z({color:"rgba(0, 0, 0, 0.5)"}),image:new h.Z({fill:new d.Z({color:"rgba(0, 0, 0, 0.5)"}),stroke:new l.Z({color:"rgba(0, 255, 255, 1)",width:2}),radius:3})}),new u.ZP({image:new f.Z({fill:new d.Z({color:"rgba(0, 0, 0, 0.2)"}),stroke:new l.Z({color:"rgba(0, 0, 0, 1)",width:2}),points:4,radius:8,angle:Math.PI/4}),geometry:function(e){var t=e.getGeometry()instanceof v.ZP?e.getGeometry().getCoordinates()[0]:e.getGeometry().getCoordinates();return new m.Z(t)}})]}},{key:"getVectorStyle",value:function(e){return[new u.ZP({stroke:new l.Z({color:"rgba(0, 0, 0, 1)",width:3}),fill:new d.Z({color:"rgba(0, 0, 0, 0.5)"}),image:new h.Z({fill:new d.Z({color:"rgba(0, 0, 0, 0.5)"}),stroke:new l.Z({color:"rgba(0, 0, 0, 1)",width:3}),radius:4})})]}},{key:"getHiddenStyle",value:function(e){return[new u.ZP({stroke:new l.Z({color:"rgba(0, 0, 0, 0)",width:0}),fill:new d.Z({color:"rgba(1, 2, 3, 0)"}),image:new h.Z({fill:new d.Z({color:"rgba(0, 0, 0, 0)"}),stroke:new l.Z({color:"rgba(0, 0, 0, 0)",width:0}),radius:0})})]}},{key:"getSketchStyle",value:function(){return[new u.ZP({fill:new d.Z({color:"rgba(255, 255, 255, 0.5)"}),stroke:new l.Z({color:"rgba(0, 0, 0, 0.5)",width:4}),image:new h.Z({radius:6,fill:new d.Z({color:"rgba(0, 0, 0, 0.5)"}),stroke:new l.Z({color:"rgba(255, 255, 255, 0.5)",width:2})})})]}},{key:"filterByDefaultValue",value:function(e){var t=this;return e.filter((function(e){return t.editSource.editableFields.some((function(t){var i=e.getProperties()[t.name];return!(!t.hidden||i!==t.defaultValue)}))}))}},{key:"loadData",value:function(e,t,i){var n,s=this,c=new URL(e.url),u={},l=(0,o.Z)(c.searchParams.entries());try{for(l.s();!(n=l.n()).done;){var d=(0,r.Z)(n.value,2),h=d[0],f=d[1];u[h.toUpperCase()]=f}}catch(y){l.e(y)}finally{l.f()}var v=(0,a.Z)((0,a.Z)({},u),{},{SERVICE:"WFS",VERSION:"1.1.0",REQUEST:"GetFeature",TYPENAME:e.layers[0],SRSNAME:e.projection}),m=new URLSearchParams(v);c.search=m.toString(),(0,P.hfetch)(c.toString()).then((function(e){if(200!==e.status)return i("data-load-error");e.text().then((function(e){return e.includes("ows:ExceptionReport")?i("data-load-error"):(s.loadDataSuccess(e),i("data-load-success"))}))})).catch((function(e){return console.warn("Error loading vectorsource... ".concat(e)),i("data-load-error")}))}},{key:"editAttributes",value:function(e){this.editFeature=e,this.observer.publish("editFeature",e)}},{key:"featureSelected",value:function(e){var t=this;0===e.selected.length&&this.editAttributes(null,null),e.selected.forEach((function(i){!i.getId()&&i.getProperties().user&&t.select.getFeatures().remove(i),e.mapBrowserEvent.filty=!0,t.editAttributes(i)}))}},{key:"refreshEditingLayer",value:function(){var e=this;this.map.getLayers().getArray().filter((function(t){return t.getProperties().caption===e.editSource.caption})).forEach((function(e){if(e.getSource){var t=e.getSource();if(t.clear&&t.clear(),t.getParams){var i=t.getParams();i.t=(new Date).getMilliseconds(),t.updateParams(i)}t.changed&&t.changed()}}))}},{key:"setLayer",value:function(e,t){var i=this;this.source=this.sources.find((function(t){return t.id===e})),this.filty=!0,this.vectorSource=new p.Z({loader:function(e){return i.loadData(i.source,e,t)},strategy:g.$6,projection:this.source.projection}),this.layer=new y.Z({layerType:"system",zIndex:5e3,name:"pluginEdit",caption:"Edit layer",source:this.vectorSource,style:this.getVectorStyle()}),this.layer&&this.map.removeLayer(this.layer),this.map.addLayer(this.layer),this.editSource=this.source,this.editFeature=null,this.observer.publish("editSource",this.source),this.observer.publish("editFeature",null),this.observer.publish("layerChanged",this.layer)}},{key:"activateModify",value:function(){var e=this;this.select=new S.Z({style:this.getSelectStyle(),toggleCondition:Z.Fi,layers:[this.layer]}),this.select.on("select",(function(t){e.featureSelected(t,e.source)})),this.modify=new w.Z({features:this.select.getFeatures()}),this.map.addInteraction(this.select),this.map.addInteraction(this.modify)}},{key:"activateAdd",value:function(e){var t=this;this.draw=new k.ZP({source:this.vectorSource,style:this.getSketchStyle(),type:e,stopClick:!0,geometryName:this.geometryName}),this.draw.on("drawend",(function(e){e.feature.modification="added",t.editAttributes(e.feature),setTimeout((function(){t.deactivateInteraction()}),1)})),this.map.addInteraction(this.draw),this.map.clickLock.add("edit")}},{key:"activateRemove",value:function(){this.remove=!0,this.map.on("singleclick",this.removeSelected)}},{key:"activateMove",value:function(){this.move=new b.Z({layers:[this.layer]}),this.map.addInteraction(this.move)}},{key:"activateInteraction",value:function(e,t){"add"===e&&this.activateAdd(t),"move"===e&&this.activateMove(),"modify"===e&&this.activateModify(),"remove"===e&&(this.map.clickLock.add("edit"),this.activateRemove()),this.map.snapHelper.add("measure")}},{key:"deactivateInteraction",value:function(){this.map.snapHelper.delete("measure"),this.select&&this.map.removeInteraction(this.select),this.modify&&this.map.removeInteraction(this.modify),this.draw&&this.map.removeInteraction(this.draw),this.move&&this.map.removeInteraction(this.move),this.remove&&(this.remove=!1,this.map.clickLock.delete("edit"),this.map.un("singleclick",this.removeSelected))}},{key:"reset",value:function(){this.editSource=void 0,this.editFeature=void 0,this.removeFeature=void 0,this.removalToolMode="off",this.filty=!1,this.map.clickLock.delete("edit"),this.layer&&(this.map.removeLayer(this.layer),this.layer=void 0),this.deactivateInteraction()}},{key:"deactivate",value:function(){this.reset(),this.observer.publish("editFeature",this.editFeature),this.observer.publish("editSource",this.editSource),this.observer.publish("deactivate")}},{key:"getSources",value:function(){return this.options.sources}}]),e}();t.default=L}}]);
//# sourceMappingURL=4906.fa00fbfe.chunk.js.map