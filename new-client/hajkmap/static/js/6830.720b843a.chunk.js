"use strict";(self.webpackChunkhajk_client=self.webpackChunkhajk_client||[]).push([[6830],{86830:(e,t,i)=>{i.r(t),i.d(t,{default:()=>F});var r=i(66274),s=i(99359),a=i(38629),n=i(42708),o=i(37130),h=i(35125),l=i(64802),c=i(9501),g=i(10430),d=i(5426),m=i(56957),p=i(62652),u=i(24673),w=i(68789),y=i(64665),x=i(66233),f=i(90927),L=i(70328),v=i(57707),S=i(2421),T=i(92245),I=i(88617),P=(0,s.Z)("getPngDependencies"),C=(0,s.Z)("saveToPdf"),B=(0,s.Z)("saveToPng");class F{constructor(e){var t;this.defaultScaleBarLengths={200:10,500:50,1e3:100,2e3:200,5e3:500,1e4:1e3,2e4:2e3,5e4:5e3,1e5:1e4,2e5:2e4,3e5:2e4},this.previewLayer=null,this.previewFeature=null,this.marginAmount=.03,this.margin=0,this.textIconsMargin=0,this.pdfCreationCancelled=null,this.getMapScale=()=>{this.printView.setZoom(this.originalView.getZoom());const e=this.printView.getProjection().getMetersPerUnit();return this.printView.getResolution()*e*39.37*(25.4/.28)},this.getFittingScale=()=>{const e=this.getMapScale();return this.scales.reduce(((t,i)=>Math.abs(i-e)<Math.abs(t-e)?i:t))},this.removePreview=()=>{this.previewFeature=void 0,this.previewLayer.getSource().clear(),this.map.removeInteraction(this.translate)},this.getPreviewCenter=()=>{const e=this.previewFeature.getGeometry().getExtent();return(0,o.getCenter)(e)},this.getMargin=e=>{const t=Math.max(...e);return this.marginAmount*t},this.getPaperDim=(e,t)=>"portrait"===t?[...this.dims[e]].reverse():this.dims[e],this.renderPreviewFeature=(e,t)=>{e?this.addPreview(t):this.removePreview()},this.getImageDataBlobFromUrl=e=>new Promise(((t,i)=>{const r=new Image;r.setAttribute("crossOrigin","anonymous"),r.onerror=function(e){i(e)},r.onload=function(){const e=document.createElement("canvas");e.width=this.naturalWidth,e.height=this.naturalHeight,e.getContext("2d").drawImage(this,0,0),t({data:e.toDataURL("image/png"),width:e.width,height:e.height})},r.src=e})),this.getImageForPdfFromUrl=async(e,t)=>{const{data:i,width:r,height:s}=await this.getImageDataBlobFromUrl(e),a=t/r;return{data:i,width:r*a,height:s*a}},this.getPlacement=(e,t,i,r,s)=>{const a=this.textIconsMargin+this.margin;let n={x:0,y:0};return"topLeft"===e?(n.x=a,n.y=a):"topRight"===e?(n.x=r-t-a,n.y=a):"bottomRight"===e?(n.x=r-t-a,n.y=s-i-a):(n.x=a,n.y=s-i-a),n},this.getFittingScaleBarLength=e=>{const t=this.scaleBarLengths[e];return t||(e<250?5:e<2500?.02*e:.05*e)},this.getLengthText=e=>{let t="m";return e>1e3&&(e/=1e3,t="km"),"".concat(Number(e).toLocaleString()," ").concat(t)},this.getDivLinesArrayAndDivider=(e,t)=>{const i=e.toString(),r=parseInt(i.substring(0,2)),s=r>=10&&r<=19?i.length-2:i.length-1,a=e/Math.pow(10,s),n=t/a;let o=[];for(let h=n;h<=t;h+=n)o.push(h);return{divLinesArray:o,divider:a}},this.addDividerLinesAndTexts=e=>{this.drawDividerLines(e),this.scaleBarLengths[e.scale]&&this.addDividerTexts(e)},this.addDividerTexts=e=>{let{pdf:t,scaleBarPosition:i,scaleBarLength:r,scaleBarLengthMeters:s,color:a}=e;t.setFontSize(8),t.setTextColor(a),t.text("0",i.x-.7,i.y+8);const n=s>1e3?(s/1e3).toString():s,{divLinesArray:o,divider:h}=this.getDivLinesArrayAndDivider(s,r),l=o[0]>10&&s>10;let c=n/h,g=c.toLocaleString();t.text(g,i.x+o[0]-g.length,i.y+8);const d=Math.round(o.length/2);if(c=n/h*d,g=c.toLocaleString(),t.text(g,i.x+o[d-1]-g.length,i.y+8),l){const e=o[0]/5;c=n/h/5,g=c.toLocaleString();const r=c%1!==0?g.length-1:g.length;t.text(g,i.x+e-r,i.y+8)}},this.drawScaleBar=(e,t,i,r,s,a,n,o)=>{const h=this.getLengthText(a);e.setFontSize(8),e.setTextColor(i),e.setLineWidth(.25),e.text(h,t.x+r+1,t.y+4),e.setFontSize(10),e.text("Skala: ".concat(this.getUserFriendlyScale(s)," (vid ").concat(n.toUpperCase()," ").concat("landscape"===o?"liggande":"st\xe5ende",")"),t.x,t.y-1),this.addDividerLinesAndTexts({pdf:e,scale:s,scaleBarLengthMeters:a,scaleBarPosition:t,scaleBarLength:r,color:i})},this.addScaleBar=(e,t,i,r,s,a,n,o)=>{const h=25.4/r/a,l=this.getFittingScaleBarLength(i),c=l*h,g=this.getPlacement(s,c+9,6,e.internal.pageSize.width,e.internal.pageSize.height);this.drawScaleBar(e,g,t,c,i,l,n,o)},this.desiredPrintOptionsOk=e=>{const t=e.resolution,i=e.scale/1e3;return this.getScaleResolution(i,t,this.map.getView().getCenter())>=this.printView.getMinResolution()},this.getScaleResolution=(e,t,i)=>e/(0,n._Q)(this.map.getView().getProjection(),t/25.4,i),this.getMapBackgroundColor=()=>{const e=document.getElementById("map").style.backgroundColor;return""!==e?e:"white"},this.getVisibleTileAndImageLayers=()=>this.map.getLayers().getArray().filter((e=>e.getVisible()&&this.layerIsTileOrImageLayer(e))),this.layerIsTileOrImageLayer=e=>e instanceof v.Z&&e.getSource()instanceof S.Z||e instanceof L.Z&&e.getSource()instanceof T.Z,this.getVisibleImageLayers=()=>this.map.getLayers().getArray().filter((e=>e.getVisible()&&e instanceof L.Z&&e.getSource()instanceof T.Z)),this.getLayerPlacementIndex=e=>this.map.getLayers().getArray().map((e=>e.get("name"))).indexOf(e.get("name")),this.exchangeLayer=e=>{try{var t,i;e.setVisible(!1),this.hiddenLayers.add(e);const r=e.getSource(),s=new T.Z({...r.getProperties(),projection:r.getProjection(),crossOrigin:null!==(t=r.crossOrigin)&&void 0!==t?t:"anonymous",params:{...r.getParams()},ratio:1,hidpi:!1}),a=null!==(i=e.getOpacity())&&void 0!==i?i:1,n=new L.Z({opacity:a,source:s,zIndex:e.getZIndex()}),o=this.getLayerPlacementIndex(e);this.map.getLayers().insertAt(o,n),this.addedLayers.add(n)}catch(r){console.error("Failed to exchange the supplied layer with a print-layer! Error: ".concat(r))}},this.getBoundingBoxFromUrl=e=>e.searchParams.get("BBOX").split(",").map((e=>parseFloat(e))),this.loadImageTile=(e,t)=>{const i=e.getContext("2d"),{url:r,x:s,y:a,tileWidth:n,tileHeight:o}=t;return new Promise(((e,t)=>{const h=document.createElement("img");h.onload=()=>{i.drawImage(h,s,a,n,o),e()},h.onerror=()=>{t()},h.crossOrigin="anonymous",h.src=r}))},this.getTileColumn=(e,t,i)=>{const r=[];for(;;){const s=r.reduce(((e,t)=>e+t.tileHeight),0);if(s>=e)return r;const a=e-s,n=a>this.maxTileSize?this.maxTileSize:a,o=e-s-n;r.push({x:t,y:o,tileWidth:i,tileHeight:n})}},this.getVersionThreeBoundingBox=(e,t,i,r)=>{const s=(t[2]-t[0])/i,a=(t[3]-t[1])/r;return"".concat(t[0]+s*(i-e.y-e.tileHeight),",").concat(t[1]+a*e.x,",").concat(t[0]+s*(i-e.y),", ").concat(t[1]+a*(e.x+e.tileWidth))},this.getVersionOneBoundingBox=(e,t,i,r)=>{const s=(t[3]-t[1])/i,a=(t[2]-t[0])/r;return"".concat(t[0]+a*e.x,",").concat(t[1]+s*(i-e.y-e.tileHeight),",").concat(t[0]+a*(e.x+e.tileWidth),",").concat(t[1]+s*(i-e.y))},this.appendBoundingBox=(e,t,i,r,s)=>{for(const a of e)a.bBox="1.3.0"===s?this.getVersionThreeBoundingBox(a,t,i,r):this.getVersionOneBoundingBox(a,t,i,r)},this.getTileInformation=(e,t,i)=>{const r=[],s=this.getBoundingBoxFromUrl(i),a=i.searchParams.get("VERSION");let n=0;for(;!(n>=t);){const i=t-n,s=i>this.maxTileSize?this.maxTileSize:i;r.push(...this.getTileColumn(e,n,s)),n+=s}return this.appendBoundingBox(r,s,e,t,a),r},this.prepareImageLayer=(e,t)=>{try{e.getSource().setImageLoadFunction(((e,i)=>{const r=new URL(i),s=r.searchParams;s.set("DPI",t.resolution),s.set("MAP_RESOLUTION",t.resolution),s.set("FORMAT_OPTIONS","dpi:".concat(t.resolution));const a=parseFloat(s.get("HEIGHT"))||1,n=parseFloat(s.get("WIDTH"))||1;if(Math.max(a,n)>this.maxTileSize){const t=this.getTileInformation(a,n,r),i=document.createElement("canvas");i.width=n,i.height=a;const s=[];for(const e of t){const t=new URL(r.toString());t.searchParams.set("BBOX",e.bBox),t.searchParams.set("HEIGHT",e.tileHeight),t.searchParams.set("WIDTH",e.tileWidth),s.push(this.loadImageTile(i,{...e,url:t.toString()}))}Promise.allSettled(s).then((()=>{e.getImage().src=i.toDataURL()}))}else e.getImage().src=r.toString()}))}catch(i){console.error("Failed to update the DPI-options while creating print-image (Single-tile WMS). Error: ".concat(i))}},this.prepareActiveLayersForPrint=e=>{for(const t of this.getVisibleTileAndImageLayers())this.exchangeLayer(t,e);for(const t of this.getVisibleImageLayers())this.prepareImageLayer(t,e)},this.resetPrintLayers=()=>{for(const e of this.hiddenLayers)e.setVisible(!0);for(const e of this.addedLayers)this.map.removeLayer(e);this.hiddenLayers=new Set,this.addedLayers=new Set},this.setupFonts=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ROBOTO_NORMAL";if(e.addFileToVFS("roboto-normal.ttf",I.ROBOTO_NORMAL),e.addFont("roboto-normal.ttf","roboto-normal","normal"),"ROBOTO_NORMAL"===t)e.setFont("roboto-normal")},this.print=e=>{const t=e.format,i=e.orientation,r=e.resolution,s=e.scale/1e3,n="portrait"===i?[...this.dims[t]].reverse():this.dims[t],l=Math.round(n[0]*r/25.4),c=Math.round(n[1]*r/25.4);this.useCustomTileLoaders&&this.prepareActiveLayersForPrint(e),this.printView.setCenter(this.originalView.getCenter()),this.map.setView(this.printView),this.originalMapSize=this.map.getSize();const g=this.getScaleResolution(s,r,this.map.getView().getCenter());this.map.once("rendercomplete",(async()=>{if(!0===this.pdfCreationCancelled)return this.pdfCreationCancelled=!1,!1;await(0,a.delay)(500);const r=document.createElement("canvas");r.width=l,r.height=c;const s=r.getContext("2d"),o=this.getMapBackgroundColor();s.fillStyle=o,s.fillRect(0,0,l,c),document.querySelectorAll(".ol-viewport canvas").forEach((e=>{if(e.width>0){const t=e.parentNode.style.opacity;if(s.globalAlpha=""===t?1:Number(t),e.style.transform){const t=e.style.transform.match(/^matrix\(([^(]*)\)$/)[1].split(",").map(Number);CanvasRenderingContext2D.prototype.setTransform.apply(s,t)}s.drawImage(e,0,0)}}));const d=new h.ZP({orientation:i,format:t,putOnlyUsedFonts:!0,compress:!0});if(this.setupFonts(d,"ROBOTO_NORMAL"),d.addImage(r,"JPEG",0,0,n[0],n[1]),this.includeImageBorder&&(d.setDrawColor(this.textColor),d.setLineWidth(.5),d.rect(.3,.3,n[0]-.5,n[1]-0,"S")),this.margin>0)if(d.setDrawColor("white"),e.useTextIconsInMargin){let t="a5"===e.format?this.margin+2:this.margin;d.setLineWidth(6*t),d.rect(-2*t,0,n[0]+4*t,n[1],"S"),this.includeImageBorder&&(d.setDrawColor(this.textColor),d.setLineWidth(.5),d.rect(t,3*t,n[0]-2*t,n[1]-6*t,"S"))}else d.setLineWidth(2*this.margin),d.rect(0,0,n[0],n[1],"S"),this.includeImageBorder&&(d.setDrawColor(this.textColor),d.setLineWidth(.5),d.rect(this.margin,this.margin,n[0]-2*this.margin,n[1]-2*this.margin,"S"));if(e.includeLogo&&this.logoUrl.trim().length>=5)try{const{data:t,width:i,height:r}=await this.getImageForPdfFromUrl(this.logoUrl,this.logoMaxWidth);let s=this.getPlacement(e.logoPlacement,i,r,n[0],n[1]);d.addImage(t,"PNG",s.x,s.y,i,r)}catch(m){this.localObserver.publish("error-loading-logo-image")}if(e.includeNorthArrow&&this.northArrowUrl.trim().length>=5)try{const{data:t,width:i,height:r}=await this.getImageForPdfFromUrl(this.northArrowUrl,this.northArrowMaxWidth),s=this.getPlacement(e.northArrowPlacement,i,r,n[0],n[1]);d.addImage(t,"PNG",s.x,s.y,i,r)}catch(m){this.localObserver.publish("error-loading-arrow-image")}if(e.includeScaleBar&&this.addScaleBar(d,e.mapTextColor,e.scale,e.resolution,e.scaleBarPlacement,g,e.format,e.orientation),e.mapTitle.trim().length>0){let t=e.useTextIconsInMargin?8+this.margin:12+this.margin;d.setFontSize(24),d.setTextColor(e.mapTextColor),d.text(e.mapTitle,n[0]/2,t,{align:"center"})}if(e.printComment.trim().length>0){let t=e.useTextIconsInMargin?13+this.margin:18+this.margin;d.setFontSize(11),d.setTextColor(e.mapTextColor),d.text(e.printComment,n[0]/2,t,{align:"center"})}if(this.copyright.length>0){let t=e.useTextIconsInMargin?this.textIconsMargin+this.margin/2:this.margin;d.setFontSize(8),d.setTextColor(e.mapTextColor),d.text(this.copyright,n[0]-4-t,n[1]-5.5-t,{align:"right"})}if(this.date.length>0){const t=this.date.replace("{date}",(new Date).toLocaleDateString());let i=e.useTextIconsInMargin?this.textIconsMargin+this.margin/2:this.margin;d.setFontSize(8),d.setTextColor(e.mapTextColor),d.text(t,n[0]-4-i,n[1]-2-i,{align:"right"})}if(this.disclaimer.length>0){let t=e.useTextIconsInMargin?this.textIconsMargin+this.margin/2:this.margin;d.setFontSize(8),d.setTextColor(e.mapTextColor);let i=d.splitTextToSize(this.disclaimer,n[0]/2-this.margin-8),r=d.getTextDimensions(i,{fontSize:8});d.text(i,n[0]-4-t,n[1]-6-t-r.h,{align:"right"})}this.useCustomTileLoaders&&this.resetPrintLayers(),this.saveToFile(d,l,e.saveAsType).then((()=>{this.localObserver.publish("print-completed")})).catch((e=>{console.warn(e),this.localObserver.publish("print-failed-to-save")})).finally((()=>{this.restoreOriginalView()}))}));const d=(0,o.getCenter)(this.previewFeature.getGeometry().getExtent());this.previewLayer.setVisible(!1),this.map.getTargetElement().style.width="".concat(l,"px"),this.map.getTargetElement().style.height="".concat(c,"px"),this.map.updateSize(),this.map.getView().setCenter(d),this.map.getView().setResolution(g)},this.restoreOriginalView=()=>{this.previewLayer.setVisible(!0),this.map.setSize(this.originalMapSize),this.map.getTargetElement().style.width="",this.map.getTargetElement().style.height="",this.map.updateSize(),this.map.setView(this.originalView)},Object.defineProperty(this,P,{writable:!0,value:async()=>{try{return{pdfjs:await Promise.all([i.e(3661),i.e(8611)]).then(i.t.bind(i,43661,23))}}catch(e){throw new Error("Failed to import required dependencies. Error: ".concat(e))}}}),Object.defineProperty(this,C,{writable:!0,value:async(e,t)=>{try{e.save("".concat(t,".pdf"))}catch(i){throw new Error("Failed to save PDF. Error: ".concat(i))}}}),Object.defineProperty(this,B,{writable:!0,value:async(e,t,i)=>{try{const{pdfjs:s}=await(0,r.Z)(this,P)[P]();s.GlobalWorkerOptions.workerSrc="//cdnjs.cloudflare.com/ajax/libs/pdf.js/".concat(s.version,"/pdf.worker.js");const a=e.output("arraybuffer");s.getDocument({data:a}).promise.then((e=>{e.getPage(1).then((e=>{let r=document.createElement("canvas"),s=r.getContext("2d");const a=e.getViewport({scale:1}),n=i/a.width,o=e.getViewport({scale:n}),h={canvasContext:s,viewport:o};r.height=o.height,r.width=o.width,e.render(h).promise.then((()=>{r.toBlob((e=>{(0,l.saveAs)(e,"".concat(t,".png"))}))}))}))}))}catch(s){throw new Error("Failed to save PNG. Error: ".concat(s))}}}),this.saveToFile=async(e,t,i)=>{const s="Kartexport - ".concat((new Date).toLocaleString());try{switch(i){case"PDF":return(0,r.Z)(this,C)[C](e,s);case"PNG":return(0,r.Z)(this,B)[B](e,s,t);default:throw new Error("Supplied type could not be handled. The supplied type was ".concat(i," and currently only PDF and PNG is supported."))}}catch(a){throw new Error("Failed to save file... ".concat(a))}},this.cancelPrint=()=>{this.pdfCreationCancelled=!0,this.restoreOriginalView(),this.useCustomTileLoaders&&this.resetPrintLayers()},this.getUserFriendlyScale=e=>"1:".concat(Number(e).toLocaleString()),this.map=e.map,this.dims=e.dims,this.logoUrl=e.options.logo||"",this.northArrowUrl=e.options.northArrow||"",this.logoMaxWidth=e.options.logoMaxWidth,this.includeImageBorder=e.options.includeImageBorder,this.northArrowMaxWidth=e.options.northArrowMaxWidth,this.scales=e.options.scales,this.scaleMeters=e.options.scaleMeters,this.scaleBarLengths=this.calculateScaleBarLengths(),this.copyright=e.options.copyright||"",this.date=e.options.date||"",this.disclaimer=e.options.disclaimer||"",this.localObserver=e.localObserver,this.mapConfig=e.mapConfig,this.useCustomTileLoaders=null===(t=e.options.useCustomTileLoaders)||void 0===t||t,this.maxTileSize=e.options.maxTileSize||4096,this.textColor=e.options.mapTextColor,this.originalView=this.map.getView(),this.originalMapSize=null,this.hiddenLayers=new Set,this.addedLayers=new Set,this.printView=new g.ZP({center:this.originalView.getCenter(),constrainOnlyCenter:this.mapConfig.constrainOnlyCenter,constrainResolution:!1,maxZoom:24,minZoom:0,projection:this.originalView.getProjection(),resolutions:this.mapConfig.allResolutions,zoom:this.originalView.getZoom()})}calculateScaleBarLengths(){return this.scales.length===this.scaleMeters.length?this.scales.reduce(((e,t,i)=>(e[t]=this.scaleMeters[i],e)),{}):this.defaultScaleBarLengths}addPreviewLayer(){this.previewLayer=new c.Z({source:new d.Z,layerType:"system",zIndex:5e3,name:"pluginPrint",caption:"Print layer",style:new y.ZP({stroke:new x.Z({color:"rgba(0, 0, 0, 0.7)",width:2}),fill:new f.Z({color:"rgba(255, 145, 20, 0.4)"})})}),this.map.addLayer(this.previewLayer)}addPreview(e){const t=e.scale,i=e.format,r=e.orientation,s=e.useMargin,a=!!s&&e.useTextIconsInMargin,n=this.getPaperDim(i,r);this.margin=s?this.getMargin(n):0,this.textIconsMargin=a?0:6;const h=25.4/.28,l=this.includeImageBorder&&!e.useMargin?1:2*this.margin,c=this.includeImageBorder&&!e.useMargin?1:e.useTextIconsInMargin&&"a5"===i?8*this.margin:e.useTextIconsInMargin?6*this.margin:2*this.margin,g=(n[0]-l)/25.4*h,d=(n[1]-c)/25.4*h,y=this.previewFeature?(0,o.getCenter)(this.previewFeature.getGeometry().getExtent()):this.map.getView().getCenter(),x=g/h/39.37*t/2*1,f=d/h/39.37*t/2*1,L=[[[y[0]-x,y[1]-f],[y[0]-x,y[1]+f],[y[0]+x,y[1]+f],[y[0]+x,y[1]-f],[y[0]-x,y[1]-f]]],v=new p.Z({geometry:new m.ZP(L)});this.removePreview(),this.previewFeature=v,this.previewLayer.getSource().addFeature(v),this.translate=new u.Z({features:new w.Z([v])}),this.map.addInteraction(this.translate)}drawDividerLines(e){let{pdf:t,scaleBarPosition:i,scaleBarLength:r,color:s,scaleBarLengthMeters:a}=e;t.setLineWidth(.25).setDrawColor(s),t.line(i.x,i.y+3,i.x+r,i.y+3),t.line(i.x,i.y+1,i.x,i.y+5),t.line(i.x+r,i.y+1,i.x+r,i.y+5);const{divLinesArray:n}=this.getDivLinesArrayAndDivider(a,r);if(n.forEach((e=>{const r=10===n.length&&e===n[4]?.7:0;t.line(i.x+e,i.y+1.9-r,i.x+e,i.y+4.1+r)})),n[0]>10){const e=n[0]/5;for(let r=e;r<n[0];r+=e)t.line(i.x+r,i.y+2.25,i.x+r,i.y+3.85)}}}}}]);
//# sourceMappingURL=6830.720b843a.chunk.js.map