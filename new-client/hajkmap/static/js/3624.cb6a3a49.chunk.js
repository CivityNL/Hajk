"use strict";(self.webpackChunkhajk_client=self.webpackChunkhajk_client||[]).push([[3624],{73624:(e,t,r)=>{r.r(t);var i=r(63252),s=r(64665),a=r(66233),o=r(90927),c=r(5400),n=r(50315),h=r(18029),l=r(56957),d=r(95881),u=r(62652),g=r(9501),v=r(5426),m=r(28562),p=r(56134),y=r(50007),f=r.n(y),w=r(25806);t.default=class{constructor(e){var t;this.setFormValuesFromConfig=()=>{this.serviceConfig?this.formValues=this.serviceConfig.editableFields.reduce(((e,t)=>(e[t.name]=this.valueByDataType(t),e)),{}):this.formValues={}},this.app=e.app,this.map=e.map,this.observer=e.observer,this.globalObserver=e.globalObserver,this.activeServices=[e.options.serviceId],this.sources=[e.options.serviceConfig],this.vectorSource=void 0,this.layer=void 0,this.select=void 0,this.modify=void 0,this.key=void 0,this.editFeature=void 0,this.editSource=void 0,this.filty=!1,this.saving=!1,this.geometryName="geom",this.wkt=null!==(t=e.options.wkt)&&void 0!==t&&t,this.serviceConfig=e.options.serviceConfig,this.serviceConfig?(this.setFormValuesFromConfig(),this.setLayer(e.options.serviceConfig)):console.warn("Edit service is missing or not properly configured.")}valueByDataType(e){switch(e.dataType){case"date-time":return(new Date).getTime();case"int":case"number":return 0;case"string":return"flerval"===e.textType?e.values.map((e=>({checked:!1,value:e}))):"";default:return""}}write(e){var t=new i.Z,r=this.editSource.layers[0].split(":"),s=2===r.length?r[0]:"",a=2===r.length?r[1]:r[0],o={featureNS:this.editSource.uri,featurePrefix:s,featureType:a,hasZ:!1,version:"1.1.0",srsName:this.editSource.projection};return t.writeTransaction(e.inserts,e.updates,e.deletes,o)}refreshLayer(e){var t,r=this.map.getLayers().getArray().find((t=>{var r=!1;if(t.getSource().getParams){let i=t.getSource().getParams();if("object"===typeof i){let t=i.LAYERS.split(":"),s=e.split(":");2===t.length&&2===s.length&&(r=e===i.LAYERS),1===t.length&&(r=s[1]===i.LAYERS)}}return r}));r&&((t=r.getSource()).changed(),t.updateParams({time:Date.now()}),this.map.updateSize())}parseWFSTresponse(e){var t="string"!==typeof e?(new XMLSerializer).serializeToString(e):e;return(new(f())).xml2js(t)}transact(e,t){var r=this.write(e),i=new XMLSerializer,s=this.editSource,a=r?i.serializeToString(r):void 0;a&&!1===this.saving&&(this.saving=!0,(0,w.hfetch)(s.url,{method:"POST",body:a,credentials:"same-origin",headers:{"Content-Type":"text/xml"}}).then((e=>{this.saving=!1,e.text().then((e=>{this.refreshLayer(s.layers[0]),this.vectorSource.getFeatures().filter((e=>void 0!==e.modification)).forEach((e=>e.modification=void 0)),t(this.parseWFSTresponse(e))}))})).catch((e=>{this.saving=!1,e.text().then((e=>{t(e)}))})))}save(e){var t=this.vectorSource.getFeatures();const r={...this.formValues};Object.keys(r).forEach((e=>{Array.isArray(r[e])&&(r[e]=r[e].filter((e=>e.checked)).map((e=>e.value)).join(", "))})),0===t.length&&t.push(new u.Z),t.length>0&&(t[0].setProperties(r),this.transact({inserts:t},e))}getSelectStyle(e){return[new s.ZP({stroke:new a.Z({color:"rgba(0, 255, 255, 1)",width:3}),fill:new o.Z({color:"rgba(0, 0, 0, 0.5)"}),image:new c.Z({fill:new o.Z({color:"rgba(0, 0, 0, 0.5)"}),stroke:new a.Z({color:"rgba(0, 255, 255, 1)",width:2}),radius:3})}),new s.ZP({image:new n.Z({fill:new o.Z({color:"rgba(0, 0, 0, 0.2)"}),stroke:new a.Z({color:"rgba(0, 0, 0, 1)",width:2}),points:4,radius:8,angle:Math.PI/4}),geometry:e=>{var t=e.getGeometry()instanceof l.ZP?e.getGeometry().getCoordinates()[0]:e.getGeometry().getCoordinates();return new d.Z(t)}})]}getVectorStyle(e){return[new s.ZP({stroke:new a.Z({color:"rgba(255, 165, 20, 1)",width:3}),fill:new o.Z({color:"rgba(255, 165, 20, 0.5)"}),image:new h.Z({scale:.5,anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:"marker_x2.png"})})]}getHiddenStyle(e){return[new s.ZP({stroke:new a.Z({color:"rgba(0, 0, 0, 0)",width:0}),fill:new o.Z({color:"rgba(1, 2, 3, 0)"}),image:new c.Z({fill:new o.Z({color:"rgba(0, 0, 0, 0)"}),stroke:new a.Z({color:"rgba(0, 0, 0, 0)",width:0}),radius:0})})]}getSketchStyle(){return[new s.ZP({fill:new o.Z({color:"rgba(255, 255, 255, 0.5)"}),stroke:new a.Z({color:"rgba(0, 0, 0, 0.5)",width:4}),image:new c.Z({radius:6,fill:new o.Z({color:"rgba(0, 0, 0, 0.5)"}),stroke:new a.Z({color:"rgba(255, 255, 255, 0.5)",width:2})})})]}refreshEditingLayer(){this.map.getLayers().getArray().filter((e=>e.getProperties().caption===this.editSource.caption)).forEach((e=>{if(e.getSource){let r=e.getSource();if(r.clear&&r.clear(),r.getParams){var t=r.getParams();t.t=(new Date).getMilliseconds(),r.updateParams(t)}r.changed&&r.changed()}}))}setLayer(e){this.source=e,this.filty=!0,this.vectorSource=new v.Z({strategy:m.$6,projection:this.source.projection}),this.layer=new g.Z({layerType:"system",zIndex:5e3,name:"pluginCollector",caption:"Collector layer",source:this.vectorSource,style:this.getVectorStyle()}),this.layer&&this.map.removeLayer(this.layer),this.map.addLayer(this.layer),this.editSource=this.source,this.editFeature=null,this.observer.publish("editSource",this.source),this.observer.publish("editFeature",null),this.observer.publish("layerChanged",this.layer)}activateAdd(e){this.draw=new p.ZP({source:this.vectorSource,style:this.getSketchStyle(),type:e,geometryName:this.geometryName}),this.draw.on("drawend",(e=>{this.wkt||this.vectorSource.clear(),e.feature.modification="added"})),this.map.addInteraction(this.draw),this.map.clickLock.add("collector")}activateInteraction(e,t){"add"===e&&this.activateAdd(t),"move"===e&&this.activateMove(),"modify"===e&&this.activateModify(),"remove"===e&&(this.map.clickLock.add("collector"),this.activateRemove()),this.map.snapHelper.add("collector")}deactivateInteraction(){this.map.snapHelper.delete("collector"),this.select&&this.map.removeInteraction(this.select),this.modify&&this.map.removeInteraction(this.modify),this.draw&&this.map.removeInteraction(this.draw),this.move&&this.map.removeInteraction(this.move),this.snap&&this.map.removeInteraction(this.snap),this.remove&&(this.remove=!1,this.map.clickLock.delete("collector"),this.map.un("singleclick",this.removeSelected))}reset(){this.vectorSource&&this.vectorSource.clear(),this.map.clickLock.delete("collector"),this.deactivateInteraction(),this.setFormValuesFromConfig(),this.observer.publish("reset")}deactivate(){this.reset(),this.observer.publish("editFeature",this.editFeature),this.observer.publish("editSource",this.editSource),this.observer.publish("deactivate")}getSources(){return this.sources.filter((e=>this.activeServices.some((t=>t===e.id))))}}}}]);
//# sourceMappingURL=3624.cb6a3a49.chunk.js.map